!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WS=t():e.WS=t()}(self,(function(){return(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}e.d(t,{default:()=>s});var o=function(){function e(){var t,n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n={},(t="eventStack")in this?Object.defineProperty(this,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[t]=n,this.eventStack={}}var t,o;return t=e,(o=[{key:"on",value:function(e,t){var n=this.eventStack,o=n[e];o?o.push(t):n[e]=[t]}},{key:"once",value:function(e,t){var n=this.eventStack,o=n[e],i=function(){var e=!1;return function(){e||(t(),e=!0)}};o?o.push(i()):n[e]=[i()]}},{key:"off",value:function(e,t){var n=this.eventStack[e];if(!n)return(n||[]).forEach((function(e,o){e===t&&n.splice(o,1)}))}},{key:"emit",value:function(e,t){var n=this.eventStack[e];if(!n)return(n||[]).forEach((function(e){e(t)}))}}])&&n(t.prototype,o),e}();function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const s=function(){function e(t){var n=this,r=t.url,s=t.pingTimeout,a=void 0===s?15e3:s,u=t.pongTimeout,h=void 0===u?1e4:u,l=t.reconnectTimeout,f=void 0===l?2e3:l,p=t.pingMsg,v=void 0===p?"heartbeat":p,d=t.repeatLimit,k=void 0===d?null:d,b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"subprotocol";i(this,e),c(this,"options",{}),c(this,"protocols",void 0),c(this,"ws",null),c(this,"repeat",0),c(this,"lockReconnect",!1),c(this,"timeId",null),c(this,"forbidReconnect",!1),c(this,"errorStack",[]),c(this,"eventCenter",new o),c(this,"onclose",(function(){})),c(this,"onerror",(function(){})),c(this,"onopen",(function(){n.errorStack.forEach((function(e){return n.send(e)})),n.errorStack=[],n.lockReconnect=!1})),c(this,"onmessage",(function(e){try{var t=JSON.parse(e.data);n.eventCenter.emit(t.type||t.code,t.data)}catch(t){n.eventCenter.emit("code",e.data||e),console.log(t,"error")}})),c(this,"onreconnect",(function(){})),this.options={url:r,pingTimeout:a,pongTimeout:h,reconnectTimeout:f,pingMsg:v,repeatLimit:k},this.protocols=b,this.createWebSocket()}var t,n;return t=e,(n=[{key:"createWebSocket",value:function(){try{this.ws=new WebSocket(this.options.url,this.protocols),this.initEventHandle()}catch(e){throw this.reconnect(),e}}},{key:"initEventHandle",value:function(){var e=this;this.ws.onclose=function(){e.onclose(),e.reconnect()},this.ws.onerror=function(){e.onerror(),e.reconnect()},this.ws.onopen=function(){e.repeat=0,e.onopen(),e.heartCheck()},this.ws.onmessage=function(t){e.onmessage(t),e.heartCheck()}}},{key:"reconnect",value:function(){var e=this;this.options.repeatLimit>0&&this.options.repeatLimit<=this.repeat||this.lockReconnect||this.forbidReconnect||(this.lockReconnect=!0,this.repeat++,this.onreconnect(),setTimeout((function(){e.createWebSocket(),e.lockReconnect=!1}),this.options.reconnectTimeout))}},{key:"send",value:function(e){1===this.ws.readyState?this.ws.send(e):this.errorStack.push(e)}},{key:"heartCheck",value:function(){this.heartReset(),this.heartStart()}},{key:"heartStart",value:function(){var e=this;this.forbidReconnect||(this.pingTimeoutId=setTimeout((function(){e.ws.send(e.options.pingMsg),e.pongTimeoutId=setTimeout((function(){e.ws.close()}),e.options.pongTimeout)}),this.options.pingTimeout))}},{key:"heartReset",value:function(){clearTimeout(this.pingTimeoutId),clearTimeout(this.pongTimeoutId)}},{key:"start",value:function(){this.forbidReconnect=!1,this.reconnect()}},{key:"close",value:function(){this.forbidReconnect=!0,this.heartReset(),this.ws.close()}},{key:"subscribe",value:function(e,t){this.eventCenter.on(e,t)}},{key:"unsubscribe",value:function(e,t){this.eventCenter.off(e,t)}},{key:"destroy",value:function(){this.close(),this.ws=null,this.errorStack=null,this.eventCenter=null}}])&&r(t.prototype,n),e}();return t.default})()}));